<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%">
    <head>
        <title>XML Output</title>
        <script type="text/javascript" src="../../tiny_mce_popup.js"></script>
        <script type="text/javascript" src="../../jquery.js"></script>
        <script type="text/javascript" src="../../wce_tei.js"></script>
    </head>
    <body style="height:95%" style="display:none; overflow:hidden;">
        <div style="height:90%; margin-bottom:10px" id="div0">
            <textarea name="html2teiOutputContainer" id="html2teiOutputContainer" style="width: 100%; overflow-y:visible; height: 98%; font-family: 'Courier New',Courier,monospace; font-size: 12px;" dir="ltr" wrap="on" class="mceFocus"></textarea>
        </div>
        <div class="mceActionPanel">
            <input type="button" id="close" value="{#close}" onclick="tinyMCEPopup.close();" />
			<input type="button" id="copy" value="{#wce.clipboard}" onclick="copyToClipboard();" />
        </div>

    </body>
    <script type="text/javascript">
		tinyMCEPopup.onInit.add(function(_ed) {
			var x = document.getElementById('html2teiOutputContainer');
			x.style.height = document.getElementById('div0').offsetHeight + "px";
			var str = _ed.getContent();
			var teiContent = getTeiByHtml(str, _ed.settings);
			if (teiContent) {
				teiContent = formatXml(teiContent);
				x.value = teiContent;
			}

		});

		function formatXml(xml) {
			var formatted = '';
			var reg = /(>)(<)(\/*)/g;
			xml = xml.replace(reg, '$1\r\n$2$3');
			var pad = 0;
			jQuery.each(xml.split('\r\n'), function(index, node) {
				var indent = 0;
				if (node.match(/.+<\/\w[^>]*>$/)) {
					indent = 0;
				} else if (node.match(/^<\/\w/)) {
					if (pad != 0) {
						pad -= 1;
					}
				} else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
					indent = 1;
				} else {
					indent = 0;
				}

				var padding = '';
				for (var i = 0; i < pad; i++) {
					padding += ' ';
				}

				formatted += padding + node + '\r\n';
				pad += indent;
			});

			return formatted;
		}
		function copyToClipboard () {
			html2teiOutputContainer.select();
			window.alert(tinyMCE.activeEditor.getLang('wce.clipboard_note'));
		}
    </script>
</html>
