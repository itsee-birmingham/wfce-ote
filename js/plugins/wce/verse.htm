<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%">
<head>
<title>{#wce.verses_title}</title>
<script type="text/javascript" src="../../tiny_mce_popup.js"></script>
<script type="text/javascript" src="js/wce.js"></script>
<script type="text/javascript" src="../../jquery.js"></script>
</head>
<body id="table">
	<form onsubmit="return false;" action="#">
		<input type="button" id="help" name="help" value="{#wce.help}"
				onclick="wce_openWindow('docu.htm#verse')" style="margin-bottom:100px" />
		<div id="insertDiv">
			<div id="insertVerseDiv">
				<input type="radio" id="insertVerseRadio" name="versemodify" onclick="canInsertVerse();"/>{#wce.verse_insert}&nbsp;&nbsp;&nbsp;
				<input id="insertVerseNumber" type="text" />
			</div>
			<div id="insertInscriptioDiv">
				<input type="radio" id="insertInscriptioRadio" name="versemodify" onclick="canInsertInscriptio();"/>{#wce.inscriptio_insert}
			</div>
			<div id="insertSubscriptioDiv">
				<input type="radio" id="insertSubscriptioRadio" name="versemodify" onclick="canInsertSubscriptio();"/>{#wce.subscriptio_insert}
			</div>
			<div id="insertChapterDiv">
				<input type="radio" id="insertChapterRadio" name="versemodify" onclick="canInsertChapter();"/>{#wce.chapter_insert}&nbsp;&nbsp;&nbsp;
				<input id="insertChapterNumber" type="text" />
			</div>
			<div id="insertBookDiv">
				<input type="radio" id="insertBookRadio" name="versemodify" onclick="canInsertBook();"/>{#wce.book_insert}&nbsp;&nbsp;&nbsp;
				<input id="insertBookNumber" type="text" />
			</div>
		</div>
		<div id="deleteVerseDiv" style="margin-top:10px">
			<div>
				<input type="radio" id="deleteVerseRadio" onclick="canDeleteVerse();" name="versemodify"/>{#wce.verse_remove}
			</div>
			<fieldset style="border:1px solid #ccc;width:auto; height:auto; overflow-y:auto" id="verseList"></fieldset>
		</div>
		<div id="deleteChapterDiv" style="margin-top:10px">
			<div>
				<input type="radio" id="deleteChapterRadio" onclick="canDeleteChapter();" name="versemodify"/>{#wce.chapter_remove}
			</div>
			<fieldset style="border:1px solid #ccc;width:auto; height:auto; overflow-y:auto" id="chapterList"></fieldset>
		</div>
		<div id="deleteBookDiv" style="margin-top:10px">
			<div>
				<input type="radio" id="deleteBookRadio" onclick="canDeleteBook();" name="versemodify"/>{#wce.book_remove}
			</div>
			<fieldset style="border:1px solid #ccc;width:auto; height:auto; overflow-y:auto" id="bookList"></fieldset>
		</div>
		<div class="mceActionPanel" style="margin-bottom:10px">
			<input type="button" id="insert" name="insert" value="{#insert}"
				onclick="update();tinyMCEPopup.close();" />
			<input type="button" id="cancel" name="cancel" value="{#cancel}"
				onclick="tinyMCEPopup.close();" />
		</div>
	</form>
</body>
<script type="text/javascript">
var verseNode; 
var contentWithVerse;

	tinyMCEPopup.onInit.add(function(_ed){
		ed=_ed;
		setConstants(); 
		init();
	}); 
	
	function canInsertVerse(){
		$('#insertVerseRadio').attr('checked','checked');
		$('#insertVerseNumber').removeAttr('disabled');
		$('#insertVerseNumber').focus();
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#insertBookNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
	
	function canInsertInscriptio(){
		$('#insertInscriptioRadio').attr('checked','checked');
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#insertBookNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
	
	function canInsertSubscriptio(){
		$('#insertSubscriptioRadio').attr('checked','checked');
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#insertBookNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
	
	function canInsertBook(){
		$('#insertChapterBook').attr('checked','checked');
		$('#insertBookNumber').removeAttr('disabled'); 
		$('#insertBookNumber').focus(); 
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
		
	function canInsertChapter(){
		$('#insertChapterRadio').attr('checked','checked');
		$('#insertChapterNumber').removeAttr('disabled'); 
		$('#insertChapterNumber').focus(); 
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#insertBookNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
	
	function canDeleteVerse(){
		$('#deleteVerseRadio').attr('checked','checked');
		$('#verseList').removeAttr('disabled');
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#insertBookNumber').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
	
	function canDeleteChapter(){
		$('#deleteChapterRadio').attr('checked','checked');
		$('#chapterList').removeAttr('disabled');
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#insertBookNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#bookList').attr('disabled','disabled');
	}
	
	function canDeleteBook(){
		$('#deleteBookRadio').attr('checked','checked');
		$('#bookList').removeAttr('disabled');
		$('#insertVerseNumber').attr('disabled','disabled');
		$('#insertChapterNumber').attr('disabled','disabled');
		$('#inserBookNumber').attr('disabled','disabled');
		$('#verseList').attr('disabled','disabled');
		$('#chapterList').attr('disabled','disabled');
	}
	
	function init() {
		canDeleteVerse();
		contentWithVerse=$('<div/>').html(ed.getContent())[0]; //selects everything starting the complete chapter
		$('#verseList').html(getVerseList(contentWithVerse));
		$('#chapterList').html(getChapterList(contentWithVerse));
		$('#bookList').html(getBookList(contentWithVerse));
		if(wce_node){
		   if(wce_node.nodeName.toLowerCase()=='span'){
		       $('#insertDiv input').attr('disabled',true);
		   }
		}
	}
	
	function getVerseList(node){
		var out="";
		if(!node || node.nodeType != 1){
			return out;
		}
		
		var list=node.childNodes;
		for(var i=0,len=list.length; i<len; i++){
			var n=list[i];
			if(n.nodeType==1){
				out+=getVerseList(n); 
			}
		}
		
		var className=node.className;
		if(className && className.match(/verse_number/)){
			var v=$.trim(node.innerHTML);
			if(v && v!='')
				out+='<input type="checkbox" value="'+v+'">Verse '+v+'</input><br />'; 
		}	
		return out;		
	}
	
	function getChapterList(node){
		var out="";
		if(!node || node.nodeType != 1){
			return out;
		}
		
		var list=node.childNodes;
		for(var i=0,len=list.length; i<len; i++){
			var n=list[i];
			if(n.nodeType==1){
				out+=getChapterList(n); 
			}
		}
		
		var className=node.className;
		if(className && className.match(/chapter_number/)){
			var v=$.trim(node.innerHTML);
			if(v && v!='')
				out+='<input type="checkbox" value="'+v+'">Chapter '+v+'</input><br />'; 
		}	
		return out;		
	}
	
	function getBookList(node){
		var out="";
		if(!node || node.nodeType != 1){
			return out;
		}
		
		var list=node.childNodes;
		for(var i=0,len=list.length; i<len; i++){
			var n=list[i];
			if(n.nodeType==1){
				out+=getBookList(n); 
			}
		}
		
		var className=node.className;
		if(className && className.match(/book_number/)){
			var v=$.trim(node.innerHTML);
			if(v && v!='')
				out+='<input type="checkbox" value="'+v+'">Book '+v+'</input><br />'; 
		}	
		return out;		
	}
		
	function update(){ 
		if ($('#insertVerseRadio').attr('checked')){
			var newVerseNr = $('#insertVerseNumber').val().trim();
			newVerseNr = newVerseNr.replace(/\D/g,'');
			if (newVerseNr != ''){
				ed.selection.setContent('<span class="verse_number" wce="__t=verse_number"> ' + newVerseNr + '</span> ');
			}
			return;
		} else if ($('#insertInscriptioRadio').attr('checked')){
			ed.selection.setContent('<span class="chapter_number" wce="__t=chapter_number"> ' + 'Inscriptio ' + '</span><span class="verse_number" wce="__t=verse_number"></span>PLACE THE INCIPIT HERE! ');
			return;
		} else if ($('#insertSubscriptioRadio').attr('checked')){
			ed.selection.setContent('<span class="chapter_number" wce="__t=chapter_number"> ' + 'Subscriptio ' + '</span><span class="verse_number" wce="__t=verse_number"></span>PLACE THE SUBSCRIPTIO HERE! ');
			return;
		} else if ($('#insertChapterRadio').attr('checked')){
			var newChapterNr = $('#insertChapterNumber').val().trim();
			newChapterNr = newChapterNr.replace(/\D/g,'');
			if (newChapterNr != ''){
				ed.selection.setContent('<span class="chapter_number" wce="__t=chapter_number"> ' + newChapterNr + '</span> ');
			}
			return;
		} else if ($('#insertBookRadio').attr('checked')){
			var newBookNr = $('#insertBookNumber').val().trim();
			newBookNr = newBookNr.replace(/\D/g,'');
			if (newBookNr != ''){
				ed.selection.setContent('<span class="book_number" wce="__t=book_number"> ' + newBookNr + '</span> ');
			}
			return;
		} else if ($('#deleteVerseRadio').attr('checked')){
			var verseList=$('#verseList').find('input:checkbox');
			for (var i=0,len=verseList.length; i<len; i++){ 
				var cb=verseList[i];
				if ($(cb).attr('checked')){
					var verseNr=$(cb).val();				
					var startNode=null,endNode=null;
					var spanList=$(contentWithVerse).find('span');
					for (var j=0,len2=spanList.length; j<len2; j++){
						var span=spanList[j];
						var spanValue=$(span).html().trim();
						if (!span.className){
							continue;
						}
						if (span.className.toLowerCase()=='verse_number'){						
							if (startNode){
								endNode=span;
								break;
							} else if(spanValue==verseNr){
								startNode=span; 
							} 
						}
					}
					delVerse(startNode,endNode);
				}
			}	 
		} else if ($('#deleteChapterRadio').attr('checked')){
			var chapterList=$('#chapterList').find('input:checkbox');
			for (var i=0,len=chapterList.length; i<len; i++){ 
				var cb=chapterList[i];
				if ($(cb).attr('checked')){
					var chapterNr=$(cb).val();				
					var startNode=null,endNode=null;
					var spanList=$(contentWithVerse).find('span');
					// Loop through all <span> elements
					for (var j=0,len2=spanList.length; j<len2; j++){
						var span=spanList[j]; //actual <span>
						var spanValue=$(span).html().trim();
						if (!span.className){
							continue;
						}
						if (span.className.toLowerCase()=='chapter_number'){						
							if (spanValue == chapterNr)
								$(span).remove();
						}
					}
				}
			}
		} else if ($('#deleteBookRadio').attr('checked')){
			var bookList=$('#bookList').find('input:checkbox');
			for (var i=0,len=bookList.length; i<len; i++){ 
				var cb=bookList[i];
				if ($(cb).attr('checked')){
					var bookNr=$(cb).val();				
					var startNode=null,endNode=null;
					var spanList=$(contentWithVerse).find('span');
					// Loop through all <span> elements
					for (var j=0,len2=spanList.length; j<len2; j++){
						var span=spanList[j]; //actual <span>
						var spanValue=$(span).html().trim();
						if (!span.className){
							continue;
						}
						if (span.className.toLowerCase()=='book_number'){						
							if (spanValue == bookNr)
								$(span).remove();
						}
					}
				}
			}
		}
		ed.setContent($(contentWithVerse).html());
	}
	
	function getCursorPositionInTextOf(element) {
    var range = document.createRange(),
        curRange = window.getSelection().getRangeAt(0);
    range.setStart(element, 0);
    range.setEnd(curRange.startContainer, curRange.startOffset);
    //Measure the length of the text from the start of the given element to the start of the current range (position of the cursor)
    return document.createElement("div").appendChild(range.cloneContents()).textContent.length;
	}
	
	function delVerse(startNode,endNode){
		var start;
		var _delVerse=function(node){
			if(node==startNode){
				start=true;
			} else if (node == endNode) {
				start=false;
				return true;
			} else {
				var temp=node.childNodes;
				var list=new Array();
				for(var i=0,len=temp.length;i<len;i++){
					list[i]=temp[i];
				}				
				for(var i=0,len=list.length;i<len;i++){
					var n=list[i];
					if(_delVerse(n)){
						return true;
					}
				}
			}
			if(start){				
				$(node).remove();
			}
		}
		
		_delVerse(contentWithVerse);
	}
	
	if (!tinyMCE.isIE) {
		$(document).keydown(function(e) {
			var evt = e || window.event
			if (evt.keyCode == 13 || evt.keyCode == 10) {
				document.getElementById('insert').click();
				return false;
			}
		});
	}
</script>
</html>
