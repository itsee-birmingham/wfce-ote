<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%">
<head>
<title>Verse Modify</title>
<script type="text/javascript" src="../../tiny_mce_popup.js"></script>
<script type="text/javascript" src="js/wce.js"></script>
<script type="text/javascript" src="../../jquery.js"></script>
</head>
<body id="table">
	<form onsubmit="return false;" action="#" name="noteinfo">
		<div>
		<input type="radio" id="insertVerseRadio" name="versemodify" onclick="canInsertVerse();">{#wce.verse_insert}</input>
		<input id="insertVerseNummer" type="text" /></div>
		<div id="deleteVerseDiv" style="margin-top:10px"><div>
		<input type="radio" id="deleteVerseRadio" onclick="canDeleteVerse();" name="versemodify"/>{#wce.verse_remove}</div>
		<fieldset style="border:1px solid #ccc;width:auto; height:auto; overflow-y:auto" id="verseList"></fieldset>
		</div>
		<div class="mceActionPanel" style="margin-bottom:10px">
			<input type="button" id="ok" name="ok" value="OK"
				onclick="updateVerse();tinyMCEPopup.close();" />
			<input type="button" name="cancel" value="{#cancel}"
				onclick="tinyMCEPopup.close();" />
		</div>
	</form>
</body>
<script type="text/javascript">
var verseNode; 
var contentWithVerse;

	tinyMCEPopup.onInit.add(function(_ed){
		ed=_ed;
		setConstants(); 
		init();
	}); 
	
	function canInsertVerse(){
		$('#insertVerseRadio').attr('checked','checked');
		$('#verseList').attr('disabled','disabled');
		$('#insertVerseNummer').removeAttr('disabled'); 
	}
	function canDeleteVerse(){
		$('#insertVerseNummer').attr('disabled','disabled');
		$('#inserVerseDiv').attr('disabled','disabled');
		$('#deleteVerseRadio').attr('checked','checked');
		$('#verseList').removeAttr('disabled');
	}
	
	function init() {
		//if(!ed.selection.isCollapsed()){ 
			canDeleteVerse();
		//}else{
			//canInsertVerse();
		//}
		contentWithVerse=$('<div/>').html(ed.getContent())[0];
		$('#verseList').html(getVerseList(contentWithVerse)); 
	}
	
	function getVerseList(node){
		var out="";
		if(!node || node.nodeType!=1){
			return out;
		}
		
		var list=node.childNodes;
		for(var i=0,len=list.length; i<len; i++){
			var n=list[i];
			if(n.nodeType==1){
				out+=getVerseList(n); 
			}
		}
		
		var className=node.className;
		if(className && className.match(/verse_number/)){
			var v=$.trim(node.innerHTML);
			if(v && v!='')
				out+='<input type="checkbox" value="'+v+'">Verse '+v+'</input><br />'; 
		}	
		return out;		
	}
	
	function updateVerse(){ 
		if($('#insertVerseRadio').attr('checked')){
			var newVerseNr=$('#insertVerseNummer').val().trim();
			newVerseNr=newVerseNr.replace(/\D/g,'');
			if(newVerseNr!=''){
				ed.selection.setContent('<span class="verse_number"> '+newVerseNr+'</span>');
			}
			return;
		}
		
		var verseList=$('#verseList').find('input:checkbox');
		for(var i=0,len=verseList.length; i<len; i++){ 
			var cb=verseList[i];
			if($(cb).attr('checked')){
				var verseNr=$(cb).val();				
				var startNode=null,endNode=null;
				var spanList=$(contentWithVerse).find('span');
				for(var j=0,len2=spanList.length; j<len2; j++){
					var span=spanList[j];
					var spanValue=$(span).html().trim();
					if(!span.className){
						continue;
					}
					if(span.className.toLowerCase()=='verse_number'){						
						if(startNode){
							endNode=span;
							break;
						}else if(spanValue==verseNr){
							startNode=span; 
						} 
					}					
				}
				delVerse(startNode,endNode);
				/*
				if(startNode){ 
					var startText=document.createTextNode('[@['); 
					startNode.parentNode.insertBefore(startText,startNode);  
				}
				if(endNode){
					var endText=document.createTextNode(']@]');  
					endNode.parentNode.insertBefore(endText,endNode); 
					
				}
				
				var content=$(contentWithVerse).html();
				var index1,index2;
				if(startNode && endNode){ 
					index1 = content.indexOf("[@[");
					index2= content.indexOf("]@]");
					var con=content.substring(0,index1);
					con+=content.substring(index2+3);
					content=con;
				} 
				else if(startNode){
					index1 = content.indexOf("[@[");
					content=content.substring(0,index1); 
				}
				contentWithVerse=$('<div/>').html(content)[0];
				*/
			}
		} 
		ed.setContent($(contentWithVerse).html());  
	}
	
	function delVerse(startNode,endNode){
		var start;
		var _delVerse=function(node){
			if(node==startNode){
				start=true;
			}else if(node==endNode){
				start=false;
				return true;
			}else{
				var temp=node.childNodes;
				var list=new Array();
				for(var i=0,len=temp.length;i<len;i++){
					list[i]=temp[i];
				}				
				for(var i=0,len=list.length;i<len;i++){
					var n=list[i];
					if(_delVerse(n)){
						return true;
					}
				}
			}
			if(start){				
				$(node).remove();
			}
		}
		
		_delVerse(contentWithVerse);
	}
	
	if (!tinyMCE.isIE) {
		$(document).keydown(function(e) {
			var evt = e || window.event
			if (evt.keyCode == 13 || evt.keyCode == 10) {
				document.getElementById('ok').click();
				return false;
			}
		});
	}
</script>
</html>
